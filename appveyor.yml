# can not have space before '&&', ')' when setting env var in multiple line commands
branches:
  only:
    - master

# https://www.appveyor.com/docs/build-environment/#using-multiple-images-for-the-same-build
# APPVEYOR_BUILD_WORKER_IMAGE is used in environment matrix, image is not
environment:
  matrix:
  - _ARCH: arm64
    _CC: MINGW
    _PLATFORM: desktop
    _CACHE: msys64
  
matrix:
  fast_finish: false
  
cache:
  - C:\%_CACHE%\var\cache\pacman\pkg -> appveyor.yml

init:
  - echo NUMBER_OF_PROCESSORS=%NUMBER_OF_PROCESSORS%
  - echo PROCESSOR_IDENTIFIER=%PROCESSOR_IDENTIFIER%
  - set MSYS2_PATH_TYPE=inherit
  - set MSYS2_DIR=C:\msys64
  - set USE_TOOLCHAIN=clang
  - set NDK_HOST=windows
  - set NDK_VERSION=r21d
#https://stackoverflow.com/questions/37627248/how-to-split-a-command-over-multiple-lines-in-appveyor-yml

install:
# can not starts with %
- git submodule update --init

# - curl -O http://repo.msys2.org/msys/x86_64/msys2-keyring-r21.b39fb11-1-any.pkg.tar.xz
# - curl -O http://repo.msys2.org/msys/x86_64/msys2-keyring-r21.b39fb11-1-any.pkg.tar.xz.sig
# - C:\msys64\usr\bin\bash.exe pacman-key --verify msys2-keyring-r21.b39fb11-1-any.pkg.tar.xz.sig
- C:\msys64\usr\bin\pacman -U --noconfirm http://repo.msys2.org/msys/x86_64/msys2-keyring-r21.b39fb11-1-any.pkg.tar.xz
# install latest pacman
- C:\msys64\usr\bin\pacman -U --noconfirm http://repo.msys2.org/msys/x86_64/pacman-5.2.2-1-x86_64.pkg.tar.xz
- C:\msys64\usr\bin\pacman -U --noconfirm http://repo.msys2.org/msys/x86_64/pacman-mirrors-20200329-1-any.pkg.tar.xz
# - C:\msys64\usr\bin\pacman -U --noconfirm http://repo.msys2.org/mingw/x86_64/mingw-w64-x86_64-db-6.0.19-3-any.pkg.tar.xz
# - C:\msys64\usr\bin\pacman -U --noconfirm http://repo.msys2.org/msys/x86_64/msys.db.tar.gz 
# - C:\msys64\usr\bin\pacman -U --noconfirm http://repo.msys2.org/msys/x86_64/gnupg-2.2.20-1-x86_64.pkg.tar.xz
# - C:\msys64\usr\bin\pacman -U --noconfirm http://repo.msys2.org/msys/x86_64/libgpgme-1.14.0-1-x86_64.pkg.tar.zst


# - C:\msys64\usr\bin\pacman -U --noconfirm http://repo.msys2.org/mingw/x86_64/mingw64.db
# - C:\msys64\usr\bin\pacman -U --noconfirm http://repo.msys2.org/mingw/x86_64/mingw64.db.tar.gz

- C:\msys64\usr\bin\pacman -Su --noconfirm
- C:\msys64\usr\bin\pacman -Su --noconfirm
 
 # install packages
- C:\msys64\usr\bin\pacman -Su --noconfirm --needed VCS

- C:\msys64\usr\bin\pacman -Su --noconfirm --needed base-devel mingw-w64-x86_64-toolchain mingw-w64-cross-toolchain
- C:\msys64\usr\bin\pacman -Su --noconfirm --needed mingw-w64-x86_64-clang
- C:\msys64\usr\bin\pacman -Su --noconfirm --needed wget diffutils patch pkg-config nasm yasm
# - C:\msys64\usr\bin\pacman -Scc --noconfirm

- curl -O http://dl.google.com/android/repository/android-ndk-%NDK_VERSION%-%NDK_HOST%-x86_64.zip
- 7z x android-ndk-%NDK_VERSION%-%NDK_HOST%-x86_64.zip -o /tmp
- mv /tmp/android-ndk-%NDK_VERSION% /tmp/android-ndk
- set ANDROID_NDK=/tmp/android-ndk

- set FF_VERSION=master
- set FF_BRANCH=%FF_VERSION%
- if not [%FF_BRANCH%]==[master] set FF_BRANCH=release/%FF_VERSION%
- git clone -b %FF_BRANCH% --no-tags https://git.ffmpeg.org/ffmpeg.git ffmpeg-%FF_BRANCH%
- if /i %_PLATFORM%==desktop (
      appveyor DownloadFile "https://sourceforge.net/projects/avbuild/files/dep/dep.7z/download" -FileName dep.7z &&
      7z x -y dep.7z -otools &&
      set PKG_CONFIG_PATH_MFX=%CD%\tools\%_CC%%_ARCH%\lib\pkgconfig)

before_build:
  - set HOME=%CD%
  - set MSYSTEM=%_CC%%_ARCH% # ffmpeg configure refuses to build for mingw in pure msys. so we lie. MUST use upper case. ommited by msvc
  - if not [%CONFIG_SUFFIX%]==[] copy /y config%CONFIG_SUFFIX%.sh config.sh
  - set FFSRC=%CD%\ffmpeg-%FF_VERSION%

build_script:
# V=1 to check libmfx error, but the error disappears if V=1. WTF
#  - if /i not %_CC%==MinGW if /i not %_PLATFORM%==store set V=1
# - ./avbuild.sh android arm64
- set VC_BUILD=false
- C:\msys64\usr\bin\bash.exe --login avbuild.sh android arm64
 #   ) else (
 #     set BUILD_NOW=true&&
 #     tools\vcbuild.bat %_CC% %_PLATFORM% %_ARCH% all
 #   )

after_build:
  - set SDK_NAME=ffmpeg-%FF_VERSION%-%_PLATFORM%-%_CC%%_ARCH%
  - move sdk* %SDK_NAME%
  - 7z a %SDK_NAME%.7z %SDK_NAME%

test: off

artifacts:
  - path: '%SDK_NAME%.7z'  # relative to repo root

